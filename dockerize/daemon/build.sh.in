#!/bin/sh

set -e

dockerfile="$1"
[ -n "$dockerfile" ]

rel_source="$2"
[ -n "$rel_source" ]

source=$(realpath "$rel_source")
target=$(realpath .)

[ -d "$source" ]

if [ "$(echo @CMAKE_BUILD_TYPE@ | awk '{print tolower($0)}')" = debug ]
then
	DEBUG=true
else
	DEBUG=false
fi

if ! docker info >/dev/null 2>&1
then
	cmake -E echo "Error: You must have access to docker: add your uid to docker group"
	false
fi

if [ $DEBUG = false ]
then
	exec 1>/dev/null 2>&1
fi

image=@PROJECT_NAME@-daemon:build
docker image rm -f $image 2>/dev/null
docker build --force-rm -t $image -f "$dockerfile" "$source"

docker run --rm -t \
	   --mount type=bind,source="$target",target=/target \
	   $image cp /workdir/bundle.tar.gz /target/

docker image rm -f $image
